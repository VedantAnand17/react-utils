# Webpack
The library provides several tuneable [Webpack] configs, intended for different
kinds of target code (an [application] or a [library]), and environments
(development or production).

Common for every config variant, the library exposes it as a "config factory
function", which generates the actual configuration once called with necessary
options. That config can be further customized by the host code, and then passed
into [Webpack].

For example, one can use the production app config the following way.
In the host codebase the `/config/webpack/production.js` file is created:
```js title="/config/webpack/production.js"
const { merge } = require('webpack-merge');
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/app-production',
);

const baseConfig = configFactory({
  context: '/path/to/context/folder',
  entry: 'relative/path/to/entry/point',
});

module.exports = merge(baseConfig, {
  // Additional Webpack config to merge with the base one.
});
```

Then in the main `webpack.config.js` file do:
```js title="/webpack.config.js"
module.exports = function buildConfig(env) {
  const config = require(`./config/webpack/${env}.js`);
  // Some additional operations on config may happen here.
  return config;
}
```

## Application

### Base {#app-base}
```js
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/app-base',
);
```
This factory **function configFactory(options)** &rArr; **object** creates
the base [Webpack] config for apps, which includes the setup common for both
[development](#app-dev) and [production](#app-prod) environments. The `options`
argument is an object with the following valid fields:

- **Required**:
  - `babelEnv` - **string** - Environment to use for [Babel] compilation.
  - `context` - **string** - Base URL for relative paths resolution.
  - `entry` - **string | string[]** - Entry point(s) for the "main" chunk(s).
    Under the hood the config will prepend them by some polyfills, like
    [babel-polyfill](https://babeljs.io/docs/usage/polyfill/),
    [nodelist-foreach-polyfill](https://www.npmjs.com/package/nodelist-foreach-polyfill),
    _etc._
  - `mode` - **string** - [Webpack mode](https://webpack.js.org/concepts/mode/).
  - `publicPath` - **string** - Base URL for the output of build assets.
- **Optional**:
  - `babelLoaderOptions` - **object** - Overrides default [Babel] loader options
    for JSX and SVG files.
  - `cssLocalIdent` - **string** - Template for CSS classnames generated by
    the [Webpack]'s `css-loader`. The value is passed into the `localIdentName`
    option of the loader. It should match corresponding option in the [Babel]
    config. Defaults `hash:base64:6`.
  - `dontEmitBuildInfo` - **boolean** - Opts out of creation of `.build-info`
    file in the codebase root during the compilation.
  - `workbox` - **boolean | object** - When set the
    [Workbox's InjectManifest plugin](https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin#injectmanifest_plugin)
    is included into the array of [Webpack] plugins, and it generates server
    worker for browser. If the value is an object it is merged into options
    passed into the plugin, otherwise default options are used:
    ```json
    {
      "importWorkboxFrom": "local",
      "swSrc": "@dr.pogodin/react-utils/config/workbox/default.js",
      "swDest": "__service-worker.js"
    }
    ```

    If the service worker is generated by this option, it will be automatically
    initiated at the client side by the standard
    [client-side initialization script](docs/api/utils/client)
    provided by this library.
    
    Note that `swDest`'s value cannot be overriden by config options provided
    via `workbox` object.

  - `keepBuildInfo` - **boolean** - If set and a `.build-info` file from
    a previous build exists in the context directory, it will be loaded and
    used, rather than re-generated by the config factory. It allows to re-create
    the Webpack config during a server launch without re-generation of the build
    info file created during a previous build (and thus bundled into the
    frontend bundle).

  - `outputPath` - **string** - Output build path, relative to the `context`.
    Defaults `build`.

  - `sitemap` - **function | string** - The path to JS or JSON config for
    sitemap. It can be relative to the context, and can be a factory, which
    returns the config. The config should be compatible with
    [`sitemap`](https://www.npmjs.com/package/sitemap) library, and if
    provided the Webpack config factory will use it to gererate `sitemap.xml`
    file in the output folder, and then serve it from the app root.

The config factory returns a config object which
- Bundles font assets (EOF, OTF, SVG, TTF, WOFF, WOFF2 files)
  from the `src/assets/fonts` folder of source code and emits them into
  the `[PUBLIC_PATH]/fonts` folder.
- Bundles image assets (GIF, JPEG, JPG, PNG files) from any folder of
  source code and emits them into the `[PUBLIC_PATH]/images` folder.
- Bundle SCSS files from any folder of source code, beside `node_modules` and
  its subfolders. The files are compiled, bundled, and extracted into
  `[PUBLIC_PATH]/[CHUNK_NAME].css` chunks.
- Bundles CSS files from any folder of source code. The files are bundled and
  extracted into `[PUBLIC_PATH]/[CHUNK_NAME].css` chunks.
- Bundles JS, JSX, and SVG files. They are compiled and emitted into
  `[PUBLIC_PATH]/[CHUNK_NAME].js` chunks, using [Babel] environment
  specified in the factory options, and
  [Babel config for Webpack](/docs/api/configs/babel#client-side).
- Automatically configures the following path aliases for the compilation
  (relative paths starting with these segments are resolved relative to
  the corresponding folders):
  - **assets** for `[CONTEXT]/src/assets`;
  - **components** for `[CONTEXT]/src/shared/components`;
  - **fonts** for `[CONTEXT]/src/assets/fonts`;
  - **styles** for `[CONTEXT]/src/styles`.
- `resolve.symlinks` Webpack option is set **false** to avoid problems
  with resolution of assets from packages linked with `npm link`.
- These global variables are automatically eemulated inside the output
  JS bundle:
  - **BUILD_RNDKEY** - A random 32 bit key that can be used
    for encryption, it is set just as a global variable accessible in
    the code;
  - **BUILD_TIMESTAMP** - UTC timestamp of the beginning of the build;
  - **FRONT_END** - It is set ***true** inside the bundle, so that shared code
    can use it to determine that it is executed at the client side.
- The config opts to polyfill the `__dirname` global variable, and to ignore
  imports of the `fs` Node package;
- By default the config stores to the disk (re-writes if exists) the file
  `[CONTEXT]/.build-info` which will contain a stringified JSON
  object with the following fields:
  - **`rndkey`** &mdash; The value set for `BUILD_RNDKEY`;
  - **`timestamp`** &mdash; The value set for `BUILD_TIMESTAMP`.

### Development {#app-dev}
```js
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/app-development',
);
```
This factory **function configFactory(options)** &rArr; **object** creates
[Webpack] configuration for **development** environment. It accepts the same
options as the [base](#app-base) app config, and does the same stuff, then on
top of that it:
- Enforces **development** [Babel] environment, and sets its `cssLocalIdent`
  argument equal `[path][name]___[local]___[hash:base64:6]` to generate verbose
  classnames for CSS modules, which are handy for debug purposes.
- Adds [`webpack-hot-middleware/client?reload=true`](https://github.com/glenjamin/webpack-hot-middleware)
  to entrypoints, which is necessary for HMR (Hot Module Reloading) setup.
- Emulates the following environment variables:
  - **BABEL_ENV** and **NODE_ENV** are both set equal **development**.
  - **DEV_TOOLS** is set equal **true**.
  - **REACT_GLOBAL_STATE_DEBUG** is set equal **true**.
- Adds the following plugins:
  - [HotModuleReplacementPlugin](https://webpack.js.org/plugins/hot-module-replacement-plugin/) and
    [react-refresh-webpack-plugin](https://github.com/pmmmwh/react-refresh-webpack-plugin)
    (these are required for HMR).

### Production {#app-prod}
```js
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/app-production',
);
```
The factory **function configFactory(options)** &rArr; **object** creates
[Webpack] configuration for **production** environment. It accepts the same
options as the [base](#app-base) app config, and does the same stuff, then on
top of that it:
- Enforces **production** [Babel] environment.
- Emulates the following environment variables:
  - **BABEL_ENV** and **NODE_ENV** are both set equal to **production**.
- Adds the following plugins:
  - [CSS Minimizer Webpack Plugin](https://www.npmjs.com/package/css-minimizer-webpack-plugin);
  - [UglifyJsPlugin](https://webpack.js.org/plugins/uglifyjs-webpack-plugin/).

## Library
### Base {#lib-base}
```js
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/lib-base',
);
```

The factory **function configFactory(options)** &rArr; **object** creates
base [Webpack] config for libraries, which contains the core setup common
for [development](#lib-dev) and [production](#lib-prod) library targets.
The `options` argument is an object with the following valid fields:

- **Required**:
  - `babelEnv` - **string** - [Babel] environment.
  - `context` - **string** - Base URL for resolution of relative config paths.
  - `entry` - **string | string[]** - Entry point(s). The config may prepend
    them by necessary polyfills.
  - `library` - **string** - Library name. It is important for proper resolution
    of library assets.
- **Optional**:
  - `babelLoaderOptions` - **object** - Overrides default [Babel] options for
    JSX and SVG loading.
  - `cssLocalIdent` - **string** - The template for CSS classnames generated by
    [Webpack]'s `css-loader`. It should match the corresponding setting in
    [Babel] config. Defaults to `hash:base64:6`.
  - `mode` - **string** - [Webpack mode](https://webpack.js.org/concepts/mode/).
  - `outputPath` - **string** - Build output path. Defaults `build`.

The generated config does the following:
- References to font asset (EOF, OTF, SVG, TTF, WOFF, WOFF2) files located in
  the `src/assets/fonts` folder of the library's source code are rewritten to
  to `LIBRARY_NAME/src/assets/fonts/FILENAME.FILE_EXTENSION` so that the host
  package of the library is able to find and bundle them.
- Bundle SCSS files from any folder of source code, beside `node_modules` and
  its subfolders. The files are compiled, bundled and extracted into
  the `build/{type}/style.css` chunks.
- Bundles JS, JSX, and SVG files; they are compiled into
  `build/{type}/web.bundle.js` chunks, using the [Babel] environment
  specified in the factory options, and
  [client-side Babel config](/docs/api/configs/babel#client-side).
- Sets The following path aliases (relative paths starting with these segments
  are resolved relative to the corresponding folders):
  - **assets** for `[CONTEXT]/src/assets`.
  - **components** for `[CONTEXT]/src/shared/components`.
  - **fonts** for `[CONTEXT]/src/assets/fonts`.
  - **styles** for `[CONTEXT]/src/styles`.
- Sets `resolve.symlinks` [Webpack] option to **false** to avoid problems
  with resolution of assets from packages linked with `npm link`.
- Declares the following packages as externals:
  - `@babel/runtime`
  - `@dr.pogodin/react-global-state`
  - `@dr.pogodin/react-themes`
  - `@dr.pogodin/react-utils`
  - `axios`
  - `dayjs`
  - `lodash`
  - `prop-types`
  - `qs`
  - `react`
  - `react-dom`
  - `react-helmet`
  - `react-router-dom`
  - `uuid`
  - `url-parse`

### Development {#lib-dev}
```js
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/lib-development',
);
```
Extends and tunes the [base library config](#lib-base) for **development**
environment. This factory **function configFactory(options)** &rArr; **object**
accepts the same options, and does the same stuff. On top of that
it modifies the template for generated classnames to equal
`[path][name]___[local]___[hash:base64:6]` which is handy for debug purposes,
and does some other small modifications of config.

### Production {#lib-prod}
```js
const configFactory = require(
  '@dr.pogodin/react-utils/config/webpack/lib-production',
);
```
Extends and tunes the [base library config](#lib-base) for **production**
environment. This factory **function configFactory(options)** &rArr; **object**
accepts the same options, and does all the same stuff, and on top of that
slightly modifies the resulting config as required for production needs.

[Application]: #application
[Babel]: https://babeljs.io/
[Library]: #library
[Webpack]: https://webpack.js.org
